<!DOCTYPE html>
<html>
<head>
  <title>Princeton Map</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  
  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    #map {
      height: 100vh;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    #filterColumn.active + #map {
      left: 0;
    }
    #backButton, #searchButton {
      position: fixed;
      top: 20px;
      z-index: 1001;
      padding: 10px 20px;
      background-color: #f57c00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    #backButton {
      left: 20px;
    }
    #searchButton {
      left: 100px;
    }
    #backButton:hover, #searchButton:hover {
      background-color: #e65100;
    }
    #filterColumn {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background-color: white;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: left 0.3s ease;
      padding: 70px 15px 15px 15px;
      overflow-y: auto;
      transform: translateX(-300px);
      box-sizing: border-box;
    }
    #filterColumn.active {
      left: 0;
      transform: translateX(0);
    }
    .filter-section {
      margin-bottom: 12px;
      width: 100%;
      box-sizing: border-box;
    }
    .filter-section h3 {
      margin-top: 0;
      margin-bottom: 8px;
      color: #333;
      font-size: 16px;
    }
    .filter-option {
      margin: 5px 0;
    }
    .filter-option label {
      display: block;
      margin-bottom: 5px;
      color: #666;
    }
    .filter-option input[type="range"] {
      width: 100%;
    }
    .filter-option select {
      width: 100%;
      padding: 6px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .star-rating {
      display: flex;
      align-items: center;
      margin-top: 5px;
    }
    .star-rating .stars {
      color: #ffd700;
      font-size: 20px;
      margin-right: 10px;
    }
    .star-rating .value {
      font-size: 16px;
      color: #666;
    }
    .popup-image {
      width: 100%;
      height: 150px;
      background-color: #e0e0e0;
      margin: 10px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 14px;
      border-radius: 4px;
    }
    .interested-button {
      width: 100%;
      padding: 8px 12px;
      background-color: #f57c00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      margin-top: 10px;
      text-align: center;
      transition: background-color 0.2s;
    }
    .interested-button:hover {
      background-color: #e65100;
    }
    .interested-button.interested {
      background-color: #4caf50;
    }
    .interested-button.interested:hover {
      background-color: #388e3c;
    }
    .contact-info {
      margin-top: 10px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      display: none;
    }
    .contact-info h4 {
      margin: 0 0 8px 0;
      color: #333;
      font-size: 14px;
    }
    .contact-info p {
      margin: 5px 0;
      font-size: 13px;
      color: #666;
    }
    .interested-renters {
      margin-top: 6px;
      max-height: 50px;
      overflow-y: auto;
    }
    .interested-renters h4 {
      margin: 0 0 2px 0;
      color: #333;
      font-size: 12px;
      position: sticky;
      top: 0;
      background-color: #f5f5f5;
      padding: 2px 0;
      z-index: 1;
    }
    .renter-item {
      padding: 2px 0;
      border-bottom: 1px solid #eee;
      font-size: 10px;
    }
    .renter-item:last-child {
      border-bottom: none;
    }
    .renter-item p {
      margin: 0;
      line-height: 1.2;
    }
    .renter-item b {
      font-size: 11px;
    }
    .storage-units-list {
      margin-bottom: 20px;
      width: 100%;
      box-sizing: border-box;
    }
    .storage-unit-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
      width: 100%;
      box-sizing: border-box;
    }
    .storage-unit-item:hover {
      background-color: #e0e0e0;
    }
    .storage-unit-image {
      width: 60px;
      height: 60px;
      background-color: #e0e0e0;
      border-radius: 4px;
      margin-right: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 12px;
    }
    .storage-unit-info {
      flex: 1;
    }
    .storage-unit-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    .storage-unit-details {
      font-size: 12px;
      color: #666;
    }
    .storage-unit-price {
      color: #f57c00;
      font-weight: 500;
    }
    #searchFilterButton {
      width: 100%;
      padding: 10px;
      background-color: #f57c00;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      margin: 15px 0;
      text-align: center;
      transition: background-color 0.2s;
    }
    #searchFilterButton:hover {
      background-color: #e65100;
    }
  </style>
</head>
<body>
  <button id="backButton" onclick="goBack()">Back</button>
  <button id="searchButton" onclick="toggleFilterColumn()">
    <i class="fas fa-search"></i> Search
  </button>
  <div id="filterColumn">
    <div class="filter-section">
      <h3>Storage Space</h3>
      <div class="filter-option">
        <select id="sizeSelect" onchange="filterBySize()">
          <option value="all">All Sizes</option>
          <option value="small">&lt;50 sq ft</option>
          <option value="medium">50-150 sq ft</option>
          <option value="large">150-250 sq ft</option>
          <option value="xlarge">&gt;250 sq ft</option>
        </select>
      </div>
    </div>
    <div class="filter-section">
      <h3>Cost</h3>
      <div class="filter-option">
        <select id="costSelect" onchange="filterByCost()">
          <option value="all">All Prices</option>
          <option value="low">&lt;$15 per month</option>
          <option value="medium-low">$15-30 per month</option>
          <option value="medium">$30-45 per month</option>
          <option value="medium-high">$45-60 per month</option>
          <option value="high">&gt;$60 per month</option>
        </select>
      </div>
    </div>
    <div class="filter-section">
      <h3>Contract Length</h3>
      <div class="filter-option">
        <select id="contractSelect" onchange="filterByContract()">
          <option value="all">All Lengths</option>
          <option value="1">1 month</option>
          <option value="2">1-2 months</option>
          <option value="3">2-3 months</option>
          <option value="4">3-4 months</option>
          <option value="5">4+ months</option>
        </select>
      </div>
    </div>
    <div class="filter-section">
      <h3>Distance from Campus</h3>
      <div class="filter-option">
        <select id="distanceSelect" onchange="filterByDistance()">
          <option value="all">All Distances</option>
          <option value="close">0-5 miles</option>
          <option value="medium">5-10 miles</option>
          <option value="far">10-20 miles</option>
          <option value="very-far">20+ miles</option>
        </select>
      </div>
    </div>
    <div class="filter-section">
      <h3>Minimum Rating</h3>
      <div class="filter-option">
        <div class="star-rating">
          <div class="stars">
            <i class="fas fa-star"></i>
            <i class="far fa-star"></i>
            <i class="far fa-star"></i>
            <i class="far fa-star"></i>
            <i class="far fa-star"></i>
          </div>
          <div class="value">1 star</div>
        </div>
        <input type="range" id="ratingRange" min="1" max="5" step="1" value="1" onchange="filterByRating()">
      </div>
    </div>
    <div class="storage-units-list">
      <h3>Storage Units</h3>
      <div id="storageUnitsList">
        <!-- Storage units will be added here dynamically -->
      </div>
    </div>
  </div>
  <div id="map"></div>

  <script>
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    function goBack() {
      window.location.href = '/';
    }

    function toggleFilterColumn() {
      const filterColumn = document.getElementById('filterColumn');
      filterColumn.classList.toggle('active');
    }

    function updatePriceValue(value) {
      document.getElementById('priceValue').textContent = value;
      filterMarkers();
    }

    function filterBySize() {
      applyFilters();
    }

    function filterByLocation(location) {
      filterMarkers();
    }

    function updateRating(value) {
      const stars = document.querySelectorAll('.star-rating .stars i');
      const valueDisplay = document.querySelector('.star-rating .value');
      
      // Update star display
      stars.forEach((star, index) => {
        if (index < value) {
          star.classList.add('fas');
          star.classList.remove('far');
        } else {
          star.classList.add('far');
          star.classList.remove('fas');
        }
      });
      
      // Update value display
      valueDisplay.textContent = value + (value === '1' ? ' star' : ' stars');
      
      filterMarkers();
      createStorageUnitList();
    }

    function filterByCost() {
      applyFilters();
    }

    function filterByContract() {
      applyFilters();
    }

    function filterByDistance() {
      applyFilters();
    }

    function filterByRating() {
      const rating = document.getElementById('ratingRange').value;
      updateRating(rating);
      applyFilters();
    }

    function filterMarkers() {
      const size = document.getElementById('sizeSelect').value;
      const cost = document.getElementById('costSelect').value;
      const contract = document.getElementById('contractSelect').value;
      const distance = document.getElementById('distanceSelect').value;
      const rating = parseInt(document.getElementById('ratingRange').value);
      
      // Here you would implement the actual filtering logic
      console.log('Filtering with:', { size, cost, contract, distance, rating });
    }

    // initialize map centered at Princeton
    var map = L.map('map', { zoomControl: false }).setView([40.343, -74.655], 16); 

    // add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Store markers in an array for filtering
    let markers = [];
    const interestedLocations = new Set(JSON.parse(localStorage.getItem('interestedLocations') || '[]'));

    // Fetch listings from API and create markers
    async function fetchAndCreateMarkers() {
      try {
        console.log('DEBUG: Fetching listings from API');
        const response = await fetch('/api/listings');
        if (!response.ok) {
          const errorText = await response.text();
          console.error('DEBUG: API Error:', errorText);
          throw new Error(`Failed to fetch listings: ${response.status} ${response.statusText}`);
        }
        const listings = await response.json();
        console.log('DEBUG: Fetched listings:', listings);
        
        // Clear existing markers
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];
        
        // Create new markers for each listing
        listings.forEach(listing => {
          try {
            console.log('DEBUG: Processing listing:', listing);
            if (listing.latitude && listing.longitude) {
              const marker = L.marker([listing.latitude, listing.longitude])
                .addTo(map)
                .bindPopup(`
                  <div style="font-size: 14px; width: 250px;">
                    <b style="font-size: 16px;">${listing.location}</b><br>
                    <i>${listing.description || 'No description available'}</i><br><br>
                    <div class="popup-image">
                      <span>Storage Unit Image</span>
                    </div>
                    <b>Price:</b> $${listing.cost}/month<br>
                    <b>Size:</b> ${listing.cubic_feet} cubic feet<br>
                    <b>Contract Length:</b> ${listing.contract_length_months} months<br>
                    <button class="interested-button ${interestedLocations.has(listing.id) ? 'interested' : ''}" 
                            onclick="toggleInterest('${listing.id}')">
                      <i class="fas ${interestedLocations.has(listing.id) ? 'fa-check' : 'fa-heart'}"></i> 
                      ${interestedLocations.has(listing.id) ? 'Interested' : 'Interested'}
                    </button>
                  </div>
                `, {
                  maxWidth: 300,
                  autoPan: true,
                  autoPanPadding: [50, 50],
                  closeButton: true,
                  className: 'custom-popup',
                  keepInView: true
                });
              markers.push(marker);
              console.log('DEBUG: Created marker for listing:', listing.id);
            } else {
              console.warn('DEBUG: Listing missing coordinates:', listing);
            }
          } catch (error) {
            console.error('DEBUG: Error creating marker:', error);
            console.error('DEBUG: Listing data:', listing);
          }
        });
        
        // Update the storage units list
        createStorageUnitList(listings);
      } catch (error) {
        console.error('DEBUG: Error in fetchAndCreateMarkers:', error);
      }
    }

    // Update storage unit list with actual listings
    function createStorageUnitList(listings) {
      const storageUnitsList = document.getElementById('storageUnitsList');
      storageUnitsList.innerHTML = '';
      
      listings.forEach(listing => {
        const unitElement = document.createElement('div');
        unitElement.className = 'storage-unit-item';
        unitElement.innerHTML = `
          <div class="storage-unit-image">
            <span>Image</span>
          </div>
          <div class="storage-unit-info">
            <div class="storage-unit-name">${listing.location}</div>
            <div class="storage-unit-details">
              <span class="storage-unit-price">$${listing.cost}/month</span>
              <span> • ${listing.cubic_feet} cubic feet</span>
            </div>
          </div>
        `;
        
        unitElement.addEventListener('click', () => {
          const marker = markers.find(m => {
            const content = m.getPopup().getContent();
            return content.includes(listing.location);
          });
          if (marker) {
            map.setView(marker.getLatLng(), 16);
            setTimeout(() => {
              marker.openPopup();
            }, 100);
          }
        });
        
        storageUnitsList.appendChild(unitElement);
      });
    }

    // Call fetchAndCreateMarkers when the page loads
    document.addEventListener('DOMContentLoaded', fetchAndCreateMarkers);

    // Update the filtering functions to work with the actual listings
    function applyFilters() {
      const size = document.getElementById('sizeSelect').value;
      const cost = document.getElementById('costSelect').value;
      const contract = document.getElementById('contractSelect').value;
      const distance = document.getElementById('distanceSelect').value;
      const rating = parseInt(document.getElementById('ratingRange').value);
      
      // Reset all markers to full opacity first
      markers.forEach(marker => marker.setOpacity(1));
      
      // Fetch listings again to get fresh data
      fetchAndCreateMarkers().then(() => {
        // Apply filters to the new markers
        markers.forEach(marker => {
          const content = marker.getPopup().getContent();
          const listing = listings.find(l => content.includes(l.location));
          
          if (listing) {
            let matchesAllFilters = true;
            
            // Check size filter
            if (size !== 'all') {
              const cubicFeet = listing.cubic_feet;
              if (!(
                (size === 'small' && cubicFeet < 50) ||
                (size === 'medium' && cubicFeet >= 50 && cubicFeet <= 150) ||
                (size === 'large' && cubicFeet > 150 && cubicFeet <= 250) ||
                (size === 'xlarge' && cubicFeet > 250)
              )) {
                matchesAllFilters = false;
              }
            }
            
            // Check cost filter
            if (cost !== 'all') {
              const price = listing.cost;
              if (!(
                (cost === 'low' && price < 15) ||
                (cost === 'medium-low' && price >= 15 && price <= 30) ||
                (cost === 'medium' && price > 30 && price <= 45) ||
                (cost === 'medium-high' && price > 45 && price <= 60) ||
                (cost === 'high' && price > 60)
              )) {
                matchesAllFilters = false;
              }
            }
            
            // Check contract filter
            if (contract !== 'all' && listing.contract_length_months !== parseInt(contract)) {
              matchesAllFilters = false;
            }
            
            if (!matchesAllFilters) {
              marker.setOpacity(0.5);
            }
          }
        });
      });
    }

    function toggleInterest(locationName) {
      const button = event.target.closest('.interested-button');
      const contactInfo = button.nextElementSibling;
      
      if (interestedLocations.has(locationName)) {
        interestedLocations.delete(locationName);
        button.classList.remove('interested');
        button.innerHTML = '<i class="fas fa-heart"></i> Interested';
        contactInfo.style.display = 'none';
      } else {
        interestedLocations.add(locationName);
        button.classList.add('interested');
        button.innerHTML = '<i class="fas fa-check"></i> Interested';
        contactInfo.style.display = 'block';
      }
      
      // Save to localStorage
      localStorage.setItem('interestedLocations', JSON.stringify(Array.from(interestedLocations)));
      
      // Here you would typically send this to your backend
      console.log('Interested locations:', Array.from(interestedLocations));
    }
  </script>
</body>
</html>
